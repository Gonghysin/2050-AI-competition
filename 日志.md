# AI Agent 知识竞答项目开发日志

## 2023-07-15 数据模型与数据导入

### 已完成工作

1. **设计并实现数据模型**：
   - 创建了题目模型（`question.py`）：包括基础题目类、选择题、判断题和简答题模型
   - 创建了用户模型（`user.py`）：包括角色卡、消息、用户会话和错题记录模型
   - 创建了响应模型（`response.py`）：统一的API响应格式，包含聊天/答题状态和题目信息

2. **数据库连接工具**：
   - 实现了MongoDB连接（用于存储题库和用户数据）
   - 实现了Redis连接（用于会话状态管理）
   - 使用单例模式确保连接的高效复用

3. **题目导入工具**：
   - 创建了导入脚本（`import_questions.py`）
   - 支持从CSV文件导入三种类型的题目：选择题、判断题和简答题
   - 处理了不同格式的CSV文件，并将数据转换为标准格式存入数据库

### 对后续开发的帮助

1. **数据基础**：
   - 我们现在有了完整的数据模型，为后续功能开发奠定了基础
   - 题目数据已经导入到MongoDB，可以直接被抽题功能使用
   - 用户模型设计完善，支持角色扮演和会话管理

2. **接口规范**：
   - 统一的响应格式（`AgentResponse`）确保了前后端交互的一致性
   - 清晰的状态区分（chat/quiz）使得状态管理更加简单

### 后续使用方法

1. **抽题功能**：
   ```python
   from backend.app.utils.database import questions
   
   # 随机抽取一道选择题
   choice_question = questions.find_one({"type": "choice"})
   ```

2. **用户会话管理**：
   ```python
   from backend.app.models.user import UserSession, RoleCard
   from backend.app.utils.database import users
   
   # 创建用户会话
   role_card = RoleCard(
       name="邪恶青蛙博士",
       background="疯狂科学家，自称来自异次元的天才蛙类",
       tone="狂妄自大，喜欢"呱呱"笑，经常使用科学术语和夸张表达",
       scope="科学实验、奇特发明、世界统治计划"
   )
   
   session = UserSession(
       user_id="user123",
       role_card=role_card
   )
   
   # 存储到数据库
   users.insert_one(session.dict())
   ```

3. **响应格式化**：
   ```python
   from backend.app.models.response import AgentResponse, QuizInfo
   
   # 聊天模式响应
   chat_response = AgentResponse(
       status="chat",
       message="呱呱呱！弱小的人类，你想挑战本博士的智慧吗？"
   )
   
   # 答题模式响应
   quiz_response = AgentResponse(
       status="quiz",
       message="第1题：以下哪项是地球的卫星？",
       quiz_info=QuizInfo(
           step=1,
           total=5,
           question_type="choice",
           question_id="q123",
           question="以下哪项是地球的卫星？",
           options=["火星", "木星", "月球", "太阳"]
       )
   )
   ```

### 下一步工作计划

1. 实现核心模块：
   - 意图识别模块（识别用户是否想要答题）
   - 答题工作流模块（管理整个答题流程）
   - 角色扮演模块（根据角色卡生成符合人设的回复）

2. 开发API接口：
   - 聊天接口（/api/chat）
   - 答题接口（/api/quiz/answer）
   - 用户管理接口（/api/user）

3. 实现工具函数：
   - 抽题函数（根据用户历史和难度选择合适的题目）
   - AI判分函数（尤其是简答题的评分）
   - 反馈生成函数（根据角色卡生成风格化的反馈）

## 2023-07-16 AI模块与记忆功能

### 已完成工作

1. **LLM客户端模块**：
   - 创建了`llm_client.py`，支持多种模型和提供商（云雾AI、博查AI、火爬）
   - 默认使用`gemini-2.5-flash-preview-04-17`模型
   - 实现了普通对话和流式对话功能
   - 添加了格式化输出功能，通过Prompt控制AI以JSON格式回复

2. **记忆模块**：
   - 创建了`memory.py`，管理用户会话历史和状态
   - 实现了Redis和MongoDB双层存储策略
   - 提供会话创建、消息添加、状态更新等功能
   - 支持获取格式化的对话历史供LLM使用

3. **角色卡配置**：
   - 创建了`role_cards.py`，定义了预设角色
   - 目前支持"邪恶青蛙博士"和"小智学姐"两个角色
   - 每个角色包含名称、背景、语气和范围四个属性

4. **API接口**：
   - 创建了基本的聊天API接口`/api/chat`
   - 实现了用户会话管理和对话历史记录
   - 支持角色扮演和状态转换

5. **测试脚本**：
   - 创建了`test_chat.py`测试脚本，验证实现的功能
   - 测试内容包括基本对话、角色扮演、记忆模块和带记忆的聊天流程

### 对后续开发的帮助

1. **结构化输出**：
   - AI回复已经是格式化的JSON结构，便于前端解析和处理
   - 统一的输出格式使得聊天和答题模式切换更加流畅

2. **记忆功能**：
   - 记忆模块可以存储多轮对话历史，支持上下文理解
   - 双层存储策略（Redis+MongoDB）兼顾性能和持久性

3. **角色扮演**：
   - 通过Prompt引导AI保持特定角色的语气和风格
   - 可以轻松扩展更多角色类型

### 使用方法

1. **使用LLM客户端进行对话**：
   ```python
   from backend.app.utils.llm_client import llm_client
   
   # 基本对话
   response = llm_client.chat(
       messages=[{"role": "user", "content": "你好，请介绍一下自己"}]
   )
   print(response['choices'][0]['message']['content'])
   
   # 角色扮演对话
   from backend.app.config.role_cards import EVIL_FROG_DOCTOR
   
   role_response = llm_client.chat_with_format(
       user_message="你好，请介绍一下自己",
       role_card=EVIL_FROG_DOCTOR,
       status="chat"
   )
   print(role_response.message)
   ```

2. **使用记忆模块管理对话**：
   ```python
   from backend.app.core.memory import memory_manager
   from backend.app.config.role_cards import get_role_card
   
   # 获取或创建会话
   user_id = "user123"
   session = memory_manager.get_session(user_id)
   if not session:
       role_card = get_role_card("evil_frog_doctor")
       session = memory_manager.create_session(user_id, role_card)
   
   # 添加消息
   memory_manager.add_message(user_id, "user", "你好")
   
   # 获取对话历史
   history = memory_manager.get_conversation_history(user_id)
   ```

3. **使用API接口进行对话**：
   ```bash
   # 启动API服务器
   cd backend
   python -m app.main
   
   # 发送请求
   curl -X POST "http://localhost:8000/api/chat" \
     -H "Content-Type: application/json" \
     -d '{"user_id": "user123", "message": "你好", "role_id": "evil_frog_doctor"}'
   ```

### 下一步工作计划

1. **意图识别模块**：
   - 实现基于关键词和模式匹配的简单意图识别
   - 添加更复杂的基于LLM的意图分类

2. **答题工作流**：
   - 实现完整的答题状态机
   - 添加抽题、判分、反馈等功能

3. **前端界面**：
   - 创建简单的聊天界面
   - 添加答题模式的UI组件
